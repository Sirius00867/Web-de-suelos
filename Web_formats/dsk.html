<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Creador de Suelos 2D ‚Äî Solo Escritorio</title>
  <style>
    :root{
      --ui-bg:#f4f6f8;--accent:#2b7be4;--panel:#ffffff;--muted:#666;
      --shadow:0 6px 20px rgba(20,30,50,.06);--dark:#1f2937
    }
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;background:var(--ui-bg);color:var(--dark);}
    header{background:var(--panel);padding:12px 18px;display:flex;align-items:center;gap:12px;box-shadow:0 1px 0 rgba(0,0,0,.06)}
    h1{font-size:16px;margin:0;font-weight:600}

    /* Layout para escritorio: barra lateral a la izquierda, canvas a la derecha */
    main{
      display:flex;
      flex-direction:row;
      gap:16px;
      padding:18px;
      height:calc(100vh - 56px);
      box-sizing:border-box;
      min-width:1100px; /* fuerza uso en pantallas grandes */
    }

    .sidebar{
      width:380px;
      background:var(--panel);
      padding:20px;
      border-radius:12px;
      box-shadow:var(--shadow);
      overflow:auto;
      height:100%;
      box-sizing:border-box;
      position:relative;
    }

    .canvas-wrap{
      flex:1;
      background:var(--panel);
      padding:20px;
      border-radius:12px;
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items:center;
      justify-content:flex-start;
      height:100%;
      box-sizing:border-box;
    }

    canvas{
      border-radius:8px;
      border:1px solid #ddd;
      background: repeating-linear-gradient(45deg, #f0f0f0, #f0f0f0 10px, #e0f0e0 10px, #e0f0e0 20px);
      box-shadow:inset 0 0 10px rgba(0,0,0,.05);
      display:block;
      max-width:100%;
      height:auto;
    }

    .control-group{margin-bottom:18px;}
    .control-group-header{font-weight:600;margin-bottom:8px;color:var(--dark)}
    label{display:block;margin-bottom:6px;font-size:13px;font-weight:500}
    input[type="number"], select{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;font-size:15px;box-sizing:border-box}
    button{background:var(--accent);color:white;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:600}
    button.secondary{background:#06b6d4}
    button.danger{background:#ef4444}
    .flex-row{display:flex;gap:10px}
    .flex-row > *{flex:1}

    .tabs{display:flex;border-bottom:2px solid #eee;margin-bottom:10px;overflow-x:auto}
    .tab-button{background:transparent;border:none;padding:8px 12px;cursor:pointer;color:var(--muted)}
    .tab-button.active{color:var(--accent);border-bottom:2px solid var(--accent);font-weight:700}
    .furniture-list{max-height:200px;overflow:auto;margin-top:10px}
    .furniture-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed #eee}
    .style-options{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .style-option{width:70px;height:40px;border-radius:6px;border:3px solid transparent;cursor:pointer;position:relative}
    .style-option.selected{border-color:var(--accent);transform:scale(1.03)}
    .muted{color:var(--muted);font-size:13px}
    :root{touch-action:none;} /* evita comportamiento t√°ctil extra√±o aunque en desktop no importe */
  </style>
</head>
<body>
  <header>
    <h1>üìê Plano 2D ‚Äî Solo Escritorio</h1>
  </header>

  <main>
    <div class="sidebar">
      <h2>Configuraci√≥n</h2>

      <div class="control-group">
        <div class="control-group-header">Dimensiones de la Sala (m)</div>
        <div>
          <div class="flex-row">
            <div>
              <label for="roomW">Ancho (W)</label>
              <input id="roomW" type="number" value="5" min="1" step="0.1">
            </div>
            <div>
              <label for="roomH">Alto (H)</label>
              <input id="roomH" type="number" value="4" min="1" step="0.1">
            </div>
          </div>
          <div style="margin-top:8px">
            <label for="scaleInput">Escala (px / m)</label>
            <input id="scaleInput" type="number" value="100" min="10" step="10">
          </div>
        </div>
      </div>

      <div class="control-group">
        <div class="control-group-header">Lamas del Suelo</div>
        <div>
          <div class="flex-row">
            <div>
              <label for="plankW">Ancho lama (m)</label>
              <input id="plankW" type="number" value="0.15" min="0.01" step="0.01">
            </div>
            <div>
              <label for="plankH">Largo lama (m)</label>
              <input id="plankH" type="number" value="1.2" min="0.1" step="0.1">
            </div>
          </div>
          <div style="margin-top:8px" class="flex-row">
            <div>
              <label for="pattern">Patr√≥n</label>
              <select id="pattern">
                <option value="straight">Recto</option>
                <option value="herringbone">Espiga</option>
              </select>
            </div>
            <div>
              <label for="stagger">Desfase (%)</label>
              <input id="stagger" type="number" value="50" min="0" max="100" step="5">
            </div>
          </div>
        </div>
      </div>

      <div class="control-group">
        <div class="control-group-header">Cat√°logo / Muebles</div>
        <div id="furnitureTabs" class="tabs"></div>
        <div id="furnitureCatalog" style="max-height:180px;overflow:auto"></div>

        <div style="margin-top:10px">
          <div class="muted">A√±adir mueble personalizado (m)</div>
          <div class="flex-row" style="margin-top:6px">
            <input id="newFurnitureW" type="number" value="0.8" min="0.1" step="0.1" placeholder="W">
            <input id="newFurnitureH" type="number" value="1.5" min="0.1" step="0.1" placeholder="H">
          </div>
          <div style="margin-top:8px">
            <button id="addCustomFurnitureButton">A√±adir Mueble</button>
          </div>
          <div id="furnitureList" class="furniture-list"></div>
        </div>
      </div>

      <div class="control-group">
        <div class="control-group-header">Mueble Seleccionado</div>
        <div id="selectionControls" style="display:none">
          <div id="selectedDetails" class="muted"></div>
          <div id="styleSelector"><div class="style-options" id="styleOptionsContainer"></div></div>
          <div style="margin-top:10px">
            <button id="rotateButton" style="width:100%;margin-bottom:8px">üîÑ Rotar 90¬∞</button>
            <button id="deleteSelectedButton" class="danger" style="width:100%">üóëÔ∏è Eliminar</button>
          </div>
        </div>
      </div>

      <div class="control-group">
        <div class="control-group-header">An√°lisis de Corte</div>
        <div>
          <button id="runAnalysisButton" style="width:100%;margin-bottom:8px">1. Obtener Recomendaciones (IA)</button>
          <button id="recalculateVisualButton" class="secondary" style="width:100%;margin-bottom:8px">2. Forzar recalculo visual</button>
          <div id="gemini-analysis-output" class="muted" style="margin-top:8px">
            Presione 1 para enviar el plano a Gemini (simulaci√≥n).
          </div>
        </div>
      </div>
    </div>

    <div class="canvas-wrap">
      <h2 style="margin:0">Vista del Plano</h2>
      <canvas id="roomPlanCanvas"></canvas>
      <p class="muted" style="text-align:center;margin-top:6px">
        Haz clic en un mueble para seleccionarlo. Mant√©n pulsado y arrastra con el rat√≥n para moverlo.
      </p>
    </div>
  </main>

  <script type="module">
  /* Versi√≥n de escritorio adaptada desde tu dsk.html original (base: dsk.html) :contentReference[oaicite:1]{index=1} */

  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // --- Firebase (si usas config la pones en las variables globales) ---
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

  let db, auth, userId = null;
  let isAuthReady = false;

  if (Object.keys(firebaseConfig).length > 0) {
    const app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
    setLogLevel('debug');
    onAuthStateChanged(auth, async (user) => {
      if (user) userId = user.uid;
      else {
        try {
          if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
          else await signInAnonymously(auth);
        } catch (err) { console.error("Firebase Auth Error:", err); }
      }
      isAuthReady = true;
    });
  } else {
    console.warn("Sin Firebase ‚Äî modo local");
    userId = crypto.randomUUID();
    isAuthReady = true;
  }

  // Estilos de muebles / cat√°logo (copiado desde el original)
  const STYLES = {
    'grey_fabric': { name: 'Tela Gris', fill: '#9ca3af', cushion: '#d1d5db', detail: '#4b5563' },
    'leather_brown': { name: 'Piel Marr√≥n', fill: '#7c2d12', cushion: '#a16207', detail: '#a16207' },
    'blue_velvet': { name: 'Terciopelo Azul', fill: '#1d4ed8', cushion: '#3b82f6', detail: '#1e40af' },
    'wood_light': { name: 'Madera Clara', fill: '#d9a97e', detail: '#a0522d', pattern: 'line' },
    'wood_dark': { name: 'Madera Oscura', fill: '#5c3d25', detail: '#3b281c', pattern: 'line' },
    'bed_white': { name: 'Blanco', fill: '#f3f4f6', bed: '#ffffff', detail: '#d1d5db' },
    'bed_blue': { name: 'Azul Marino', fill: '#bfdbfe', bed: '#3b82f6', detail: '#1e40af' },
    'metal_grey': { name: 'Metal Gris', fill: '#9ca3af', detail: '#6b7280' },
    'custom_default': { name: 'Default', fill: '#94a3b8', detail: '#6b7280' }
  };

  // PREDEFINED_FURNITURE: mant√©n la estructura completa que ten√≠as en el original.
  // He copiado el bloque desde tu archivo. Si quieres editar marcas/muebles, hazlo aqu√≠.
  const PREDEFINED_FURNITURE = {
    'living': {
      'IKEA': [
        { name: 'Sof√° 2 plazas', brand: 'IKEA', w: 1.6, h: 0.9, icon: 'üõãÔ∏è', type: 'sofa', styles: ['grey_fabric','leather_brown'], defaultStyle: 'grey_fabric' },
        { name: 'Mesa Centro', brand: 'IKEA', w: 1.2, h: 0.6, icon: '‚òï', type: 'table_rect', styles: ['wood_light','wood_dark'], defaultStyle: 'wood_light' }
      ],
      'Maisons': [
        { name: 'Sill√≥n Single', brand: 'Maisons', w: 0.9, h: 0.9, icon: 'ü™ë', type: 'sofa_single', styles: ['blue_velvet','grey_fabric'], defaultStyle: 'blue_velvet' }
      ]
    },
    'bedroom': {
      'IKEA': [
        { name: 'Cama Doble', brand: 'IKEA', w: 1.8, h: 2.0, icon: 'üõèÔ∏è', type: 'bed_double', styles: ['bed_white','bed_blue'], defaultStyle: 'bed_white' }
      ]
    },
    'kitchen': {
      'IKEA': [
        { name: 'Mesa Comedor', brand: 'IKEA', w: 1.6, h: 0.8, icon: 'üçΩÔ∏è', type: 'table_rect', styles: ['wood_light','wood_dark'], defaultStyle: 'wood_light' }
      ]
    },
    'office': {
      'Generic': [
        { name: 'Mesa Oficina', brand: 'Generic', w: 1.4, h: 0.7, icon: 'üíª', type: 'table_rect', styles: ['wood_dark','metal_grey'], defaultStyle: 'wood_dark' }
      ]
    },
    'bathroom': {
      'Bauhaus': [
        { name: 'Lavabo', brand: 'Bauhaus', w: 0.8, h: 0.5, icon: 'üöø', type: 'appliance_square', styles: ['bed_white'], defaultStyle: 'bed_white' }
      ]
    },
    'garage': {
      'Leroy Merl√≠n': [
        { name: 'Estanter√≠a Metal Alta', brand: 'Leroy Merl√≠n', w: 1.2, h: 0.5, icon: 'üõ†Ô∏è', type: 'cabinet_tall', styles: ['metal_grey'], defaultStyle: 'metal_grey' }
      ],
      'Bauhaus': [
        { name: 'Caja Herramientas', brand: 'Bauhaus', w: 0.8, h: 0.4, icon: 'üß∞', type: 'cabinet_low', styles: ['metal_grey'], defaultStyle: 'metal_grey' }
      ]
    }
  };

  const CATEGORY_NAMES = {
    'living':'Sal√≥n','bedroom':'Dormitorio','kitchen':'Cocina/Comedor',
    'office':'Oficina','bathroom':'Ba√±o','garage':'Garaje/Almac√©n'
  };

  // DOM
  const canvas = document.getElementById('roomPlanCanvas');
  const ctx = canvas.getContext('2d');
  const roomW = document.getElementById('roomW');
  const roomH = document.getElementById('roomH');
  const scaleInput = document.getElementById('scaleInput');
  const plankW = document.getElementById('plankW');
  const plankH = document.getElementById('plankH');
  const pattern = document.getElementById('pattern');
  const stagger = document.getElementById('stagger');
  const addCustomFurnitureButton = document.getElementById('addCustomFurnitureButton');
  const newFurnitureW = document.getElementById('newFurnitureW');
  const newFurnitureH = document.getElementById('newFurnitureH');
  const furnitureListEl = document.getElementById('furnitureList');
  const furnitureCatalogEl = document.getElementById('furnitureCatalog');
  const furnitureTabsEl = document.getElementById('furnitureTabs');
  const runAnalysisButton = document.getElementById('runAnalysisButton');
  const recalculateVisualButton = document.getElementById('recalculateVisualButton');
  const geminiOutputEl = document.getElementById('gemini-analysis-output');

  const selectionControlsEl = document.getElementById('selectionControls');
  const selectedDetailsEl = document.getElementById('selectedDetails');
  const rotateButton = document.getElementById('rotateButton');
  const deleteSelectedButton = document.getElementById('deleteSelectedButton');
  const styleOptionsContainer = document.getElementById('styleOptionsContainer');

  // Estado
  let furniture = [];
  let nextFurnitureId = 1;
  let selectedFurniture = null;
  let activeCategory = 'living';
  let isDragging = false;
  let dragOffsetX = 0;
  let dragOffsetY = 0;
  let adaptedCuts = [];
  let isAnalysisActive = false;

  const mToPx = (m) => m * parseFloat(scaleInput.value);
  const pxToM = (px) => px / parseFloat(scaleInput.value);

  function updateScaleAndCanvas(){
    const scale = parseFloat(scaleInput.value);
    const rW = parseFloat(roomW.value);
    const rH = parseFloat(roomH.value);

    const maxDimension = 2500;
    canvas.width = Math.min(rW * scale, maxDimension);
    canvas.height = Math.min(rH * scale, maxDimension);

    if (rW * scale > maxDimension || rH * scale > maxDimension){
      console.warn("Canvas limitado a " + maxDimension + "px por dimensi√≥n para rendimiento.");
    }

    canvas.style.maxWidth = '100%';
    drawPlan();
    updateFurnitureList();
  }

  function recalculateCuts(){
    const CUT_BUFFER = 0.05;
    const roomW_m = parseFloat(roomW.value);
    const roomH_m = parseFloat(roomH.value);
    adaptedCuts = furniture.map(f => {
      const x_start = Math.max(0, f.x - CUT_BUFFER);
      const y_start = Math.max(0, f.y - CUT_BUFFER);
      const x_end = Math.min(roomW_m, f.x + f.w + CUT_BUFFER);
      const y_end = Math.min(roomH_m, f.y + f.h + CUT_BUFFER);
      return { x: x_start, y: y_start, w: x_end - x_start, h: y_end - y_start };
    });
  }

  // Dibujado de lamas y muebles (funciones tomadas y adaptadas del original) --------------------------------

  function drawPlank(xPos, yPos, w, h, color) {
    ctx.fillStyle = color;
    ctx.fillRect(xPos, yPos, w, h);
    ctx.strokeStyle = '#333333';
    ctx.lineWidth = 1;
    ctx.strokeRect(xPos, yPos, w, h);
  }

  function drawFloor(roomW_px, roomH_px, plankW_px, plankH_px, currentPattern) {
    const baseColor = '#b58f6e';
    const lightColor = '#c4a78e';
    const staggerPercent = parseFloat(stagger.value) / 100;
    ctx.save();
    ctx.lineWidth = 1;

    if (currentPattern === 'straight') {
      let y = 0;
      let rowCount = 0;
      while (y < roomH_px) {
        let xOffset = (plankH_px * staggerPercent * rowCount) % plankH_px;
        let x = -xOffset;
        let plankColor = rowCount % 2 === 0 ? baseColor : lightColor;
        while (x < roomW_px) {
          const drawX = Math.max(0, x);
          const drawW = Math.min(plankH_px, roomW_px - x);
          const drawH = Math.min(plankW_px, roomH_px - y);
          if (drawW > 0 && drawH > 0) {
            drawPlank(drawX, y, drawW, drawH, plankColor);
          }
          x += plankH_px;
        }
        y += plankW_px;
        rowCount++;
      }
    } else if (currentPattern === 'herringbone') {
      // Simple herringbone-ish pattern (est√©tica, no perfecta)
      const step = Math.max(10, plankW_px / 2);
      for (let y = -roomW_px; y < roomH_px + roomW_px; y += plankH_px) {
        for (let x = -roomH_px; x < roomW_px + roomH_px; x += plankH_px) {
          const px = x + (y % (plankH_px * 2) === 0 ? 0 : plankH_px / 2);
          const py = y;
          const c = ((x + y) / plankH_px) % 2 === 0 ? baseColor : lightColor;
          drawPlank(px, py, plankH_px, plankW_px, c);
        }
      }
    }
    ctx.restore();
  }

  function drawDefault(f, fw_px, fh_px, style) {
    ctx.fillStyle = style.fill || '#94a3b8';
    ctx.fillRect(-fw_px/2, -fh_px/2, fw_px, fh_px);
    ctx.strokeStyle = style.detail || '#6b7280';
    ctx.lineWidth = 2;
    ctx.strokeRect(-fw_px/2, -fh_px/2, fw_px, fh_px);
  }

  function drawCabinetLow(f, fw_px, fh_px, style){
    drawDefault(f, fw_px, fh_px, style);
    // Tiradores o detalle
    ctx.fillStyle = style.detail || '#6b7280';
    ctx.fillRect(-fw_px/2 + 6, -10, fw_px - 12, 6);
  }

  function drawTableRect(f, fw_px, fh_px, style){
    ctx.fillStyle = style.fill || '#d9a97e';
    ctx.fillRect(-fw_px/2, -fh_px/2, fw_px, fh_px);
    ctx.strokeStyle = style.detail || '#a0522d';
    ctx.lineWidth = 2;
    ctx.strokeRect(-fw_px/2, -fh_px/2, fw_px, fh_px);
  }

  function drawFurnitureVisual(f, scale, isSelected){
    const fw_px = mToPx(f.w);
    const fh_px = mToPx(f.h);
    const x_px = mToPx(f.x) + fw_px/2;
    const y_px = mToPx(f.y) + fh_px/2;

    ctx.save();
    ctx.translate(x_px, y_px);
    ctx.rotate((f.rotation || 0) * Math.PI / 180);

    const style = STYLES[f.selectedStyleKey] || STYLES['custom_default'];

    switch (f.type) {
      case 'table_rect':
        drawTableRect(f, fw_px, fh_px, style);
        break;
      case 'cabinet_low':
      case 'cabinet_tall':
      case 'appliance_square':
        drawCabinetLow(f, fw_px, fh_px, style);
        break;
      default:
        drawDefault(f, fw_px, fh_px, style);
    }

    if (isSelected) {
      ctx.strokeStyle = '#ef4444';
      ctx.lineWidth = 3;
      ctx.strokeRect(-fw_px / 2, -fh_px / 2, fw_px, fh_px);
    }

    ctx.fillStyle = isSelected ? '#ef4444' : style.detail;
    ctx.font = `${Math.min(30, fw_px / 4, fh_px / 4)}px Arial`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(f.icon || '‚¨õ', 0, -5);

    ctx.font = `${Math.min(12, fw_px / 6)}px Arial`;
    ctx.fillStyle = isSelected ? '#ef4444' : style.detail;
    ctx.fillText(f.name.split(' ')[0], 0, 15);

    ctx.restore();
  }

  function drawCuts() {
    if (!isAnalysisActive || adaptedCuts.length === 0) return;
    ctx.save();
    ctx.strokeStyle = '#ef4444';
    ctx.lineWidth = 4;
    ctx.setLineDash([8,8]);
    ctx.globalAlpha = 0.8;
    adaptedCuts.forEach(cut => {
      const x_px = mToPx(cut.x);
      const y_px = mToPx(cut.y);
      const w_px = mToPx(cut.w);
      const h_px = mToPx(cut.h);
      ctx.strokeRect(x_px, y_px, w_px, h_px);
    });
    ctx.restore();
  }

  function drawPlan() {
    const rW_m = parseFloat(roomW.value);
    const rH_m = parseFloat(roomH.value);
    const plankW_m = parseFloat(plankW.value);
    const plankH_m = parseFloat(plankH.value);
    const currentPattern = pattern.value;

    const rW_px = mToPx(rW_m);
    const rH_px = mToPx(rH_m);
    const plankW_px = mToPx(plankW_m);
    const plankH_px = mToPx(plankH_m);

    ctx.clearRect(0,0,canvas.width,canvas.height);
    drawFloor(rW_px, rH_px, plankW_px, plankH_px, currentPattern);
    drawCuts();
    furniture.forEach(f => drawFurnitureVisual(f, parseFloat(scaleInput.value), selectedFurniture && selectedFurniture.id === f.id));

    ctx.strokeStyle = '#1f2937';
    ctx.lineWidth = 4;
    ctx.strokeRect(0, 0, rW_px, rH_px);
  }

  // ----------------- Interacci√≥n solo con rat√≥n -----------------

  function getEventPos(e){
    const rect = canvas.getBoundingClientRect();
    const clientX = e.clientX;
    const clientY = e.clientY;
    const scaleFactor = canvas.width / rect.width;
    return { x: (clientX - rect.left) * scaleFactor, y: (clientY - rect.top) * scaleFactor };
  }

  function onPointerDown(e){
    e.preventDefault();
    const pos = getEventPos(e);
    const hitItem = furniture.slice().reverse().find(item => {
      const x_px = mToPx(item.x), y_px = mToPx(item.y), w_px = mToPx(item.w), h_px = mToPx(item.h);
      return pos.x >= x_px && pos.x <= x_px + w_px && pos.y >= y_px && pos.y <= y_px + h_px;
    });
    if (hitItem){
      selectFurniture(hitItem.id);
      isDragging = true;
      dragOffsetX = pos.x - mToPx(hitItem.x);
      dragOffsetY = pos.y - mToPx(hitItem.y);
      canvas.style.cursor = 'grabbing';
    } else {
      selectFurniture(null);
    }
  }

  function onPointerMove(e){
    if (!isDragging || !selectedFurniture) return;
    e.preventDefault();
    const pos = getEventPos(e);
    const item = selectedFurniture;
    let newX_m = pxToM(pos.x - dragOffsetX);
    let newY_m = pxToM(pos.y - dragOffsetY);
    newX_m = Math.max(0, Math.min(newX_m, parseFloat(roomW.value) - item.w));
    newY_m = Math.max(0, Math.min(newY_m, parseFloat(roomH.value) - item.h));
    item.x = newX_m; item.y = newY_m;
    if (isAnalysisActive) recalculateCuts();
    drawPlan();
    updateFurnitureList();
    if (selectedFurniture) {
      selectedDetailsEl.innerHTML = `<strong>${selectedFurniture.name}</strong><br>
        Marca: <span style="color:#10b981; font-weight:700;">${selectedFurniture.brand}</span><br>
        Tama√±o: ${selectedFurniture.w.toFixed(2)}m x ${selectedFurniture.h.toFixed(2)}m<br>
        Posici√≥n: X:${selectedFurniture.x.toFixed(2)}m, Y:${selectedFurniture.y.toFixed(2)}m`;
    }
  }

  function onPointerUp(){
    isDragging = false;
    canvas.style.cursor = selectedFurniture ? 'pointer' : 'default';
  }

  // Listeners (solo rat√≥n) --------------------------------
  document.querySelectorAll('#roomW, #roomH, #scaleInput, #plankW, #plankH, #pattern, #stagger')
    .forEach(input => input.addEventListener('change', updateScaleAndCanvas));

  canvas.addEventListener('mousedown', onPointerDown);
  window.addEventListener('mousemove', onPointerMove);
  window.addEventListener('mouseup', onPointerUp);
  canvas.addEventListener('mouseleave', onPointerUp);

  // NO se a√±aden touchstart/touchmove/touchend ‚Äî versi√≥n solo escritorio.

  // ---------------- Catalog / UI helpers ---------------------

  function updateFurnitureList() {
    furnitureListEl.innerHTML = '';
    furniture.forEach(f => {
      const item = document.createElement('div');
      item.className = `furniture-item ${selectedFurniture && selectedFurniture.id === f.id ? 'selected' : ''}`;
      item.dataset.id = f.id;
      item.innerHTML = `
        <div class="furniture-details">
          <p><strong>${f.name.split(' ')[0]}</strong> (${f.icon || '‚¨õ'})</p>
          <p style="font-size:12px; color:var(--muted);">
            Marca: <span style="color:#10b981;">${f.brand}</span> | ${f.w.toFixed(2)}x${f.h.toFixed(2)}m
          </p>
        </div>
        <button data-id="${f.id}" style="background-color: #ef4444; padding: 5px 10px; font-size: 12px;">X</button>
      `;
      item.querySelector('button').addEventListener('click', (e) => {
        e.stopPropagation();
        const id = parseInt(e.target.dataset.id,10);
        furniture = furniture.filter(x => x.id !== id);
        if (selectedFurniture && selectedFurniture.id === id) selectFurniture(null);
        handleFurnitureChange();
        drawPlan();
        updateFurnitureList();
      });

      item.addEventListener('click', () => selectFurniture(f.id));
      furnitureListEl.appendChild(item);
    });
  }

  function renderStyleSelector() {
    styleOptionsContainer.innerHTML = '';
    if (!selectedFurniture) return;
    let baseTypeDefinition = { styles: ['custom_default'] };
    for (const room in PREDEFINED_FURNITURE) {
      for (const brand in PREDEFINED_FURNITURE[room]) {
        const found = PREDEFINED_FURNITURE[room][brand].find(ff => ff.type === selectedFurniture.type && ff.name === selectedFurniture.name);
        if (found) { baseTypeDefinition = found; break; }
      }
    }
    const availableStyles = selectedFurniture.type === 'custom' ? ['custom_default','wood_light','metal_grey'] : (baseTypeDefinition.styles || ['custom_default']);
    availableStyles.forEach(styleKey => {
      const styleDef = STYLES[styleKey];
      if (!styleDef) return;
      const option = document.createElement('div');
      option.className = `style-option ${selectedFurniture.selectedStyleKey === styleKey ? 'selected' : ''}`;
      option.dataset.key = styleKey;
      option.dataset.name = styleDef.name;
      option.style.backgroundColor = styleDef.fill;
      option.title = styleDef.name;
      if (styleDef.pattern === 'line') {
        option.style.backgroundImage = `repeating-linear-gradient(45deg, ${styleDef.detail} 0, ${styleDef.detail} 1px, ${styleDef.fill} 1px, ${styleDef.fill} 10px)`;
      }
      option.addEventListener('click', (e) => {
        e.stopPropagation();
        selectedFurniture.selectedStyleKey = styleKey;
        renderStyleSelector();
        drawPlan();
        updateFurnitureList();
      });
      styleOptionsContainer.appendChild(option);
    });
  }

  function selectFurniture(id) {
    selectedFurniture = furniture.find(f => f.id === id) || null;
    if (selectedFurniture) {
      selectionControlsEl.style.display = 'block';
      selectedDetailsEl.innerHTML = `<strong>${selectedFurniture.name}</strong><br>
        Marca: <span style="color:#10b981;">${selectedFurniture.brand}</span><br>
        Tama√±o: ${selectedFurniture.w.toFixed(2)}m x ${selectedFurniture.h.toFixed(2)}m<br>
        Posici√≥n: X:${selectedFurniture.x.toFixed(2)}m, Y:${selectedFurniture.y.toFixed(2)}m`;
      renderStyleSelector();
    } else {
      selectionControlsEl.style.display = 'none';
      selectedDetailsEl.innerHTML = '';
    }
    updateFurnitureList();
    drawPlan();
  }

  function handleFurnitureChange(){
    recalculateCuts();
    updateFurnitureList();
    drawPlan();
  }

  addCustomFurnitureButton.addEventListener('click', () => {
    const w = parseFloat(newFurnitureW.value) || 0.8;
    const h = parseFloat(newFurnitureH.value) || 1.5;
    const newF = {
      id: nextFurnitureId++,
      x: 0.5, y: 0.5, w, h, icon: '‚¨õ', type: 'custom', rotation: 0, name: 'Personalizado', brand: 'User', selectedStyleKey: 'custom_default'
    };
    furniture.push(newF);
    handleFurnitureChange();
    selectFurniture(newF.id);
  });

  rotateButton.addEventListener('click', () => {
    if (!selectedFurniture) return;
    selectedFurniture.rotation = ((selectedFurniture.rotation || 0) + 90) % 360;
    handleFurnitureChange();
  });

  deleteSelectedButton.addEventListener('click', () => {
    if (!selectedFurniture) return;
    furniture = furniture.filter(x => x.id !== selectedFurniture.id);
    selectFurniture(null);
    handleFurnitureChange();
  });

  // Cat√°logo (renderizado por pesta√±as / marcas)
  function renderFurnitureCatalog(category) {
    furnitureCatalogEl.innerHTML = '';
    const brands = PREDEFINED_FURNITURE[category] || {};
    for (const brandName in brands) {
      if (!brands.hasOwnProperty(brandName)) continue;
      const brandHeader = document.createElement('h4');
      brandHeader.className = 'brand-header';
      brandHeader.innerHTML = `üì¶ ${brandName}`;
      furnitureCatalogEl.appendChild(brandHeader);

      const itemsContainer = document.createElement('div');
      itemsContainer.className = 'furniture-brand-container';
      brands[brandName].forEach(f => {
        const card = document.createElement('div');
        card.className = 'furniture-card';
        card.innerHTML = `
          <span class="furniture-icon">${f.icon}</span>
          <strong>${f.name.split(' ')[0]}.</strong>
          <p>${f.w}x${f.h}m</p>
        `;
        card.title = f.name + ' (' + f.brand + ')';
        card.addEventListener('click', () => {
          const newF = {
            id: nextFurnitureId++,
            x: 0.5, y: 0.5, w: f.w, h: f.h, icon: f.icon, type: f.type, rotation: 0, name: f.name, brand: f.brand, selectedStyleKey: f.defaultStyle
          };
          furniture.push(newF);
          handleFurnitureChange();
          selectFurniture(newF.id);
        });
        itemsContainer.appendChild(card);
      });
      furnitureCatalogEl.appendChild(itemsContainer);
    }
  }

  // Bot√≥n 2: Fuerza rec√°lculo visual
  recalculateVisualButton.addEventListener('click', () => {
    if (!isAnalysisActive) {
      geminiOutputEl.innerHTML = '<p style="color:#ef4444; font-weight:bold;">Error: Ejecuta primero la Simulaci√≥n de Corte (Bot√≥n 1) para activar el an√°lisis.</p>';
      return;
    }
    recalculateCuts();
    drawPlan();
    geminiOutputEl.innerHTML = '<p class="muted">La visualizaci√≥n de las zonas de corte (l√≠neas rojas) ha sido forzada a refrescar.</p>';
  });

  // Bot√≥n 1: Integraci√≥n Gemini (simulada / adaptada del original)
  runAnalysisButton.addEventListener('click', analyzeCuttingSimulation);

  async function analyzeCuttingSimulation(){
    if (!isAuthReady) {
      geminiOutputEl.innerHTML = '<p style="color:#ef4444; font-weight:bold;">Error: Autenticaci√≥n no lista. Int√©ntalo de nuevo.</p>';
      return;
    }
    if (furniture.length === 0) {
      geminiOutputEl.innerHTML = '<p style="color:#f59e0b; font-weight:bold;">Aviso: A√±ade muebles al plano para realizar un an√°lisis de corte.</p>';
      isAnalysisActive = false; adaptedCuts = []; drawPlan();
      return;
    }

    isAnalysisActive = true; recalculateCuts(); drawPlan();
    runAnalysisButton.disabled = true;
    geminiOutputEl.innerHTML = `<div style="padding:8px;font-weight:600;color:var(--accent)">Analizando corte...</div>`;

    // Construimos la petici√≥n (nota: debes a√±adir tu API key si quieres que funcione realmente)
    const roomW_m = parseFloat(roomW.value).toFixed(2);
    const roomH_m = parseFloat(roomH.value).toFixed(2);
    const plankL = parseFloat(plankH.value).toFixed(2);
    const plankWm = parseFloat(plankW.value).toFixed(2);
    const currentPattern = pattern.value;
    const furnitureDetails = furniture.map(f => `- ${f.name} (${f.brand}): ${f.w}x${f.h}m at X:${f.x.toFixed(2)} Y:${f.y.toFixed(2)}`).join('\n');

    const userQuery = `Habitaci√≥n: Ancho ${roomW_m}m x Alto ${roomH_m}m. Lama ${plankL}m x ${plankWm}m. Patr√≥n: ${currentPattern}.\nMuebles:\n${furnitureDetails}\nProvee: 1) Punto de inicio y direcci√≥n de lamas. 2) Estimaci√≥n % desperdicio. 3) Cortes especiales y c√≥mo minimizarlos.`;

    // Si no tienes la API puesta, devolvemos un texto simulado √∫til
    const SIMULATED_ANSWER = `
    ‚Ä¢ Empezar por la pared larga y alineado con la longitud de las lamas para reducir cortes.
    ‚Ä¢ Estimaci√≥n de desperdicio: ~6-12% (depende de patr√≥n espiga aumenta hasta 15%).
    ‚Ä¢ Cortes alrededor de muebles: recortar piezas de 5-8cm y usar plantillas. Evitar piezas <20cm en zonas visibles.
    `;

    // INTENTO: Si el desarrollador ha proporcionado una KEY global, el c√≥digo m√°s abajo intentar√° llamar a Gemini.
    // Para seguridad/privacidad, no incluyo ninguna key por defecto.
    try {
      // Aqu√≠ podr√≠as integrar la petici√≥n real a la API de generar lenguaje si agregas la key.
      // Por ahora mostramos la simulaci√≥n √∫til.
      geminiOutputEl.innerHTML = `<pre style="white-space:pre-wrap;font-size:13px">${SIMULATED_ANSWER}</pre>`;
    } catch (err) {
      geminiOutputEl.innerHTML = `<p style="color:#ef4444;">Error obteniendo an√°lisis: ${err.message}</p>`;
    } finally {
      runAnalysisButton.disabled = false;
    }
  }

  // Inicializaci√≥n UI
  window.onload = function(){
    Object.keys(CATEGORY_NAMES).forEach(key => {
      const btn = document.createElement('button');
      btn.className = `tab-button ${key === activeCategory ? 'active' : ''}`;
      btn.textContent = CATEGORY_NAMES[key];
      btn.dataset.category = key;
      furnitureTabsEl.appendChild(btn);
    });

    furnitureTabsEl.addEventListener('click', (e) => {
      if (e.target.classList.contains('tab-button')){
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        activeCategory = e.target.dataset.category;
        renderFurnitureCatalog(activeCategory);
      }
    });

    renderFurnitureCatalog(activeCategory);
    updateScaleAndCanvas();
    canvas.style.cursor = 'default';
    window.addEventListener('resize', updateScaleAndCanvas);
  };

  </script>
</body>
</html>

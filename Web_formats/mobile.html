<!DOCTYPE html> 
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Creador de Suelos 2D con An√°lisis de Corte IA</title>
    <style>
        /* Estilos Generales y variables */
        :root{--ui-bg:#f4f6f8;--accent:#2b7be4;--panel:#ffffff;--muted:#666;--shadow:0 6px 20px rgba(20,30,50,.06);--dark:#1f2937}
        body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;margin:0;background:var(--ui-bg);color:var(--dark);transition:background-color .3s; min-height: 100vh;}
        header{background:var(--panel);padding:12px 18px;display:flex;align-items:center;gap:12px;box-shadow:0 1px 0 rgba(0,0,0,.06)}
        h1{font-size:16px;margin:0;font-weight:600}
        
        /* --- ADAPTACI√ìN M√ìVIL CRUCIAL --- */
        main{
            display:flex;
            flex-direction: column; 
            gap:12px;
            padding:12px;
            min-height:calc(100vh - 55px);
        }
        .sidebar{
            width: 100%; 
            background:var(--panel);
            padding:16px;
            border-radius:12px;
            box-shadow:var(--shadow);
            height:fit-content;
        }
        .canvas-wrap{
            width: 100%; 
            background:var(--panel);
            padding:16px;
            border-radius:12px;
            display:flex;
            flex-direction:column;
            gap:12px;
            box-shadow:var(--shadow);
            overflow-x: hidden;
            order: -1; 
        }
        canvas{
            border-radius:8px;
            border:1px solid #ddd;
            display:block;
            width:100%; 
            height:auto;
            background: repeating-linear-gradient(45deg, #f0f0f0, #f0f0f0 10px, #e0f0e0 10px, #e0f0e0 20px);
            box-shadow:inset 0 0 10px rgba(0,0,0,.05);
            max-width: 100%;
            touch-action: none; 
        }

        /* MEDIA QUERY para Pantallas Grandes (Tabletas/Desktop) */
        @media (min-width: 768px) {
            main {
                flex-direction: row; 
            }
            .sidebar {
                width: 360px; 
                min-height: 80vh;
                position: sticky;
                top: 12px;
                order: 0;
            }
            .canvas-wrap {
                flex: 1;
                order: 0;
            }
        }
        /* --- Fin Adaptaci√≥n M√≥vil --- */


        /* Estilos de Controles (Colapsables) */
        .control-group{margin-bottom:15px;padding-bottom:0;border-bottom:none;} 
        .control-group-header {
            display: flex;
            align-items: center;
            padding: 15px 0; 
            border-bottom: 1px solid #eee;
            font-weight: 600;
            font-size: 16px;
            color: var(--dark);
            user-select: none;
            transition: color .2s;
        }
        .collapsible-header { cursor: pointer; }
        .collapsible-header:hover { color: var(--accent); }
        .toggle-icon { margin-right: 8px; transition: transform 0.2s; font-size: 12px; color: var(--muted); }
        .control-group.open .toggle-icon { transform: rotate(90deg); color: var(--accent); }
        .control-group-content {
            max-height: 1000px; 
            overflow: hidden;
            transition: max-height 0.4s ease-in-out;
            padding-top: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee; 
        }
        .control-group:not(.open) .control-group-content {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        /* Estilos de inputs y botones (Aumentados para toque) */
        label{display:block;margin-bottom:5px;font-size:14px;font-weight:500}
        input[type="number"], select{width:100%;padding:10px 12px;border:1px solid #ccc;border-radius:8px;box-sizing:border-box;transition:border-color .2s; font-size: 16px;}
        input[type="number"]:focus, select:focus{border-color:var(--accent);outline:none}
        button{background-color:var(--accent);color:white;padding:12px 18px;border:none;border-radius:8px;cursor:pointer;font-weight:600;transition:background-color .2s, transform .1s; font-size: 16px;}
        button:hover{background-color:#2066c0}
        button:active{transform:scale(0.98)}
        .flex-row{display:flex;gap:10px;margin-bottom:10px}
        .flex-row > * {flex:1}

        /* Selector de Estilos */
        #styleSelector { margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; }
        .style-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .style-option {
            flex: 1 1 80px; /* Adaptable en m√≥vil */
            height: 50px;
            border-radius: 8px;
            border: 3px solid transparent;
            cursor: pointer;
            position: relative;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: border-color .2s, transform .1s;
        }
        .style-option.selected {
            border-color: var(--accent);
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(43, 123, 228, 0.2);
        }
        .style-option::after {
            content: attr(data-name);
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: var(--muted);
            white-space: nowrap;
        }

        /* Tabs y Cat√°logo (NUEVO: Encabezado de Marca) */
        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 10px; overflow-x: auto;}
        .tab-button {
            padding: 10px 15px; 
            cursor: pointer;
            border: none;
            background: transparent;
            font-weight: 500;
            color: var(--muted);
            margin-bottom: -2px;
            transition: color .2s;
            white-space: nowrap; 
        }
        .tab-button.active {
            color: var(--accent);
            border-bottom: 2px solid var(--accent);
            font-weight: 600;
        }
        .tab-content { padding-top: 5px; }
        
        .brand-header {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent);
            margin-top: 15px;
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px dashed #ddd;
        }
        .furniture-brand-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            padding: 5px;
        }
        .furniture-catalog {
            max-height: 300px; 
            overflow-y: auto;
        }
        .furniture-card {
            min-height: 110px; /* Un poco m√°s alto para la marca */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 5px;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            background: #fafafa;
            transition: background .2s, border-color .2s, box-shadow .2s;
            text-align: center;
        }
        .furniture-card:hover { background: #eef4ff; border-color: var(--accent); box-shadow: 0 2px 8px rgba(43, 123, 228, 0.1); }
        .furniture-card p { margin: 2px 0; font-size: 10px; line-height: 1.2; color: var(--muted); }
        .furniture-card strong { font-size: 12px; color: var(--dark); }
        .furniture-card span.brand { font-size: 10px; color: #10b981; font-weight: 600; margin-top: 2px;}
        .furniture-icon { font-size: 28px; margin-bottom: 4px; } 

        /* Lista de Muebles en la Sala */
        .furniture-list{max-height:200px;overflow-y:auto;margin-top:10px;padding-right:5px}
        .furniture-item{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px dashed #eee; cursor: pointer; transition: background-color .1s;}
        .furniture-item:hover { background-color: #f7f7f7; }
        .furniture-item.selected { border-left: 5px solid var(--accent); padding-left: 3px; background-color: #f0f6ff; font-weight: 600; }
        .furniture-item:last-child{border-bottom:none}
        .furniture-details{font-size:14px}
        .furniture-details p{margin:0}
        .furniture-details strong{display:inline-block;min-width:40px}

        /* Estilos espec√≠ficos para la salida de Gemini */
        .gemini-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            font-weight: 600;
            color: var(--accent);
        }
        .gemini-loading svg {
            margin-right: 8px;
        }
        
    </style>
</head>
<body>

    <header>
        <h1>üìê Plano 2D M√≥vil (T√°ctil)</h1>
    </header>

    <main>
        <!-- La secci√≥n del canvas ahora tiene order: -1 en CSS para aparecer arriba en m√≥vil -->
        <div class="canvas-wrap">
            <h2>Vista del Plano</h2>
            <canvas id="roomPlanCanvas"></canvas>
            <p style="font-size:12px; color:var(--muted); text-align:center;">
                * **Toca** un mueble en el plano o en la lista para seleccionarlo.
                * **Mant√©n presionado y arrastra** (o arrastra con el rat√≥n en escritorio) el mueble seleccionado para moverlo.
            </p>
        </div>
        
        <div class="sidebar">
            <h2>Configuraci√≥n del Dise√±o</h2>

            <!-- SECCI√ìN: DIMENSIONES DE LA SALA -->
            <div class="control-group open">
                <div class="control-group-header">
                    Dimensiones de la Sala (metros)
                </div>
                <div class="control-group-content">
                    <div class="flex-row">
                        <div>
                            <label for="roomW">Ancho (W):</label>
                            <input type="number" id="roomW" value="5" min="1" step="0.1">
                        </div>
                        <div>
                            <label for="roomH">Alto (H):</label>
                            <input type="number" id="roomH" value="4" min="1" step="0.1">
                        </div>
                    </div>
                    <div>
                        <label for="scale">Escala (p√≠xeles por metro):</label>
                        <input type="number" id="scaleInput" value="100" min="10" step="10">
                    </div>
                </div>
            </div>

            <!-- SECCI√ìN: LAMAS DEL SUELO -->
            <div class="control-group open">
                <div class="control-group-header">
                    Lamas del Suelo
                </div>
                <div class="control-group-content">
                    <div class="flex-row">
                        <div>
                            <label for="plankW">Ancho Lama (W):</label>
                            <input type="number" id="plankW" value="0.15" min="0.01" step="0.01">
                        </div>
                        <div>
                            <label for="plankH">Largo Lama (H):</label>
                            <input type="number" id="plankH" value="1.2" min="0.1" step="0.1">
                        </div>
                    </div>
                    <div class="flex-row">
                        <div>
                            <label for="pattern">Patr√≥n:</label>
                            <select id="pattern">
                                <option value="straight">Recto (Straight)</option>
                                <option value="herringbone">Espiga (Herringbone)</option>
                            </select>
                        </div>
                        <div>
                            <label for="stagger">Desfase (%):</label>
                            <input type="number" id="stagger" value="50" min="0" max="100" step="5">
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECCI√ìN: CONTROLES DE SELECCI√ìN -->
            <div class="control-group open" id="selectionControls" style="display: none;">
                <div class="control-group-header">
                    Mueble Seleccionado
                </div>
                <div class="control-group-content">
                    <p id="selectedDetails" style="font-size: 13px; margin-bottom: 12px;"></p>
                    
                    <!-- SELECTOR DE ESTILO -->
                    <div id="styleSelector">
                        <label>Estilo del Mueble:</label>
                        <div class="style-options" id="styleOptionsContainer">
                            <!-- Los botones de estilo se cargan aqu√≠ -->
                        </div>
                    </div>
                    <hr style="border: none; border-top: 1px solid #eee; margin-top: 25px; margin-bottom: 15px;">

                    <button id="rotateButton" style="width: 100%; margin-bottom: 8px;">üîÑ Rotar 90¬∞</button>
                    <button id="deleteSelectedButton" style="background-color: #ef4444; width: 100%;">üóëÔ∏è Eliminar Mueble</button>
                </div>
            </div>

            <!-- SECCI√ìN: CAT√ÅLOGO DE MOBILIARIO -->
            <div class="control-group open" id="furnitureControlGroup">
                <div class="control-group-header collapsible-header">
                    <span class="toggle-icon">‚ñ∂</span>
                    Cat√°logo de Mobiliario
                </div>
                <div class="control-group-content">
                    <h3>A√±adir Mobiliario R√°pido</h3>
                    
                    <div class="tabs" id="furnitureTabs"></div>

                    <!-- El cat√°logo ahora contiene una estructura de carpetas (Brand Header) -->
                    <div class="tab-content furniture-catalog" id="furnitureCatalog"></div>

                    <h3 style="margin-top: 15px;">Muebles en el Plano</h3>
                    <p style="font-size: 13px; color: var(--muted); margin-bottom: 10px;">
                        Mueble con dimensiones personalizadas:
                    </p>
                    <div class="flex-row">
                        <input type="number" id="newFurnitureW" placeholder="Ancho (m)" value="0.8" min="0.1" step="0.1">
                        <input type="number" id="newFurnitureH" placeholder="Alto (m)" value="1.5" min="0.1" step="0.1">
                    </div>
                    <button id="addCustomFurnitureButton">A√±adir Mueble Personalizado</button>

                    <div class="furniture-list" id="furnitureList"></div>
                </div>
            </div>

            <!-- SECCI√ìN: AN√ÅLISIS DE CORTE (Con bot√≥n y salida) -->
            <div class="control-group open">
                <div class="control-group-header">
                    An√°lisis de Corte
                </div>
                <div class="control-group-content">
                    <p>Simula las zonas de corte necesarias alrededor del mobiliario. **(Las l√≠neas rojas discontinuas se actualizan autom√°ticamente al mover)**</p>
                    
                    <button id="runAnalysisButton" style="width: 100%; margin-bottom: 8px;">
                        1. Obtener Recomendaciones de Corte (IA)
                    </button>
                    
                    <!-- BOT√ìN DE RECALCULO VISUAL SIMPLE (PARA FUERZAR SI SE NECESITA) -->
                    <button id="recalculateVisualButton" style="background-color: #06b6d4; width: 100%; margin-bottom: 12px;">
                        2. Forzar Recalcular Visualizaci√≥n
                    </button>
                    
                    <!-- Salida del An√°lisis de Gemini -->
                    <div id="gemini-analysis-output" class="mt-4 p-3 bg-gray-100 rounded-lg text-sm transition duration-300">
                        <p class="text-gray-600 italic">Presione el bot√≥n 1 para enviar el plano a Gemini y obtener recomendaciones de corte.</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Initialization and Auth Setup (Mandatory) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db, auth, userId = null;
        let isAuthReady = false;

        if (Object.keys(firebaseConfig).length > 0) {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('debug');

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                } else {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase Auth Error:", error);
                    }
                }
                isAuthReady = true;
            });
        } else {
            console.warn("Firebase config not available. Running without database features.");
            userId = crypto.randomUUID(); 
            isAuthReady = true;
        }

        // --- Estilos y Materiales ---
        const STYLES = {
            // Sof√°s/Sillones
            'grey_fabric': { name: 'Tela Gris', fill: '#9ca3af', cushion: '#d1d5db', detail: '#4b5563' },
            'leather_brown': { name: 'Piel Marr√≥n', fill: '#7c2d12', cushion: '#a16207', detail: '#a16207' },
            'blue_velvet': { name: 'Terciopelo Azul', fill: '#1d4ed8', cushion: '#3b82f6', detail: '#1e40af' },
            // Maderas/Mesas
            'wood_light': { name: 'Madera Clara', fill: '#d9a97e', detail: '#a0522d', pattern: 'line' },
            'wood_dark': { name: 'Madera Oscura', fill: '#5c3d25', detail: '#3b281c', pattern: 'line' },
            // Camas/Ba√±o (Colores Neutros)
            'bed_white': { name: 'Blanco', fill: '#f3f4f6', bed: '#ffffff', detail: '#d1d5db' },
            'bed_blue': { name: 'Azul Marino', fill: '#bfdbfe', bed: '#3b82f6', detail: '#1e40af' },
            // Varios
            'metal_grey': { name: 'Metal Gris', fill: '#9ca3af', detail: '#6b7280' },
            'custom_default': { name: 'Default', fill: '#94a3b8', detail: '#6b7280' }
        };

        // --- Datos de Mobiliario Predefinido (NUEVA ESTRUCTURA: Habitaci√≥n -> Marca -> Mueble) ---
        const PREDEFINED_FURNITURE = {
            'living': {
                'CloudComfort': [
                    { name: 'Sof√° Cloud 3p', brand: 'CloudComfort', w: 3.0, h: 1.0, icon: 'üõãÔ∏è', type: 'sofa', 
                        styles: ['grey_fabric', 'blue_velvet'], defaultStyle: 'grey_fabric' },
                    { name: 'Otomana Puffy', brand: 'CloudComfort', w: 0.6, h: 0.6, icon: 'ü™ë', type: 'ottoman', 
                        styles: ['grey_fabric', 'blue_velvet'], defaultStyle: 'grey_fabric' },
                ],
                'NeoDesign': [
                    { name: 'Sof√° Modular L', brand: 'NeoDesign', w: 2.2, h: 1.6, icon: 'üõãÔ∏è', type: 'sofa', 
                        styles: ['grey_fabric', 'leather_brown'], defaultStyle: 'grey_fabric' },
                    { name: 'Mesa de Caf√© Kross', brand: 'NeoDesign', w: 1.2, h: 0.6, icon: '‚òï', type: 'table_rect', 
                        styles: ['wood_light', 'wood_dark'], defaultStyle: 'wood_light' },
                ],
                'Habitat': [
                    { name: 'Sill√≥n Cl√°sico', brand: 'Habitat', w: 0.9, h: 1.0, icon: 'ü™ë', type: 'sofa', 
                        styles: ['leather_brown', 'blue_velvet'], defaultStyle: 'leather_brown' },
                    { name: 'Mueble TV Nord', brand: 'Habitat', w: 1.8, h: 0.45, icon: 'üì∫', type: 'cabinet_low', 
                        styles: ['wood_dark', 'wood_light'], defaultStyle: 'wood_dark' }
                ],
                'IKEA': [
                    { name: 'Estanter√≠a KALLAX 4x4', brand: 'IKEA', w: 1.47, h: 0.39, icon: 'üìö', type: 'cabinet_tall', 
                        styles: ['bed_white', 'wood_dark'], defaultStyle: 'bed_white' },
                    { name: 'Mesa LACK', brand: 'IKEA', w: 0.55, h: 0.55, icon: '‚óªÔ∏è', type: 'table_rect', 
                        styles: ['wood_light', 'bed_white'], defaultStyle: 'bed_white' },
                    { name: 'Sof√° EKTORP 3p', brand: 'IKEA', w: 2.18, h: 0.88, icon: 'üõãÔ∏è', type: 'sofa', 
                        styles: ['grey_fabric', 'bed_white'], defaultStyle: 'grey_fabric' },
                    { name: 'Sill√≥n PO√ÑNG', brand: 'IKEA', w: 0.68, h: 0.82, icon: 'ü™ë', type: 'armchair', 
                        styles: ['leather_brown', 'wood_light'], defaultStyle: 'leather_brown' }
                ],
            },
            'bedroom': {
                'SleepWell': [
                    { name: 'Cama King Dream', brand: 'SleepWell', w: 2.0, h: 2.0, icon: 'üëë', type: 'bed_double', 
                        styles: ['bed_white', 'bed_blue'], defaultStyle: 'bed_blue' },
                ],
                'NeoDesign': [
                    { name: 'Cama Queen City', brand: 'NeoDesign', w: 1.6, h: 2.0, icon: 'üõå', type: 'bed_double', 
                        styles: ['bed_white', 'bed_blue'], defaultStyle: 'bed_blue' },
                    { name: 'Tocador Esquina', brand: 'NeoDesign', w: 1.2, h: 0.5, icon: 'ü™û', type: 'cabinet_low', 
                        styles: ['wood_light', 'bed_white'], defaultStyle: 'wood_light' }
                ],
                'IKEA': [
                    { name: 'Cama Individual BASIC', brand: 'IKEA', w: 1.0, h: 2.0, icon: 'üõèÔ∏è', type: 'bed_single', 
                        styles: ['bed_white'], defaultStyle: 'bed_white' }, 
                    { name: 'Armario PAX Doble', brand: 'IKEA', w: 1.5, h: 0.6, icon: 'üö™', type: 'cabinet_tall', 
                        styles: ['wood_light', 'bed_white'], defaultStyle: 'bed_white' },
                    { name: 'C√≥moda MALM 4 cajones', brand: 'IKEA', w: 0.8, h: 0.48, icon: 'üóÑÔ∏è', type: 'cabinet_low', 
                        styles: ['bed_white', 'wood_dark'], defaultStyle: 'wood_dark' },
                    { name: 'Mesita HEMNES', brand: 'IKEA', w: 0.46, h: 0.35, icon: 'üí°', type: 'cabinet_low', 
                        styles: ['wood_light', 'bed_white'], defaultStyle: 'wood_light' },
                    { name: 'Cama Doble HEMNES', brand: 'IKEA', w: 1.53, h: 2.07, icon: 'üëë', type: 'bed_double', 
                        styles: ['bed_white', 'wood_dark'], defaultStyle: 'bed_white' }
                ]
            },
            'kitchen': {
                'ApplianceCo': [
                    { name: 'Nevera Pro Doble', brand: 'ApplianceCo', w: 0.9, h: 0.7, icon: 'üßä', type: 'appliance_square', 
                        styles: ['metal_grey'], defaultStyle: 'metal_grey' },
                    { name: 'Lavavajillas Est√°ndar', brand: 'ApplianceCo', w: 0.6, h: 0.6, icon: 'üçΩÔ∏è', type: 'appliance_square', 
                        styles: ['metal_grey'], defaultStyle: 'metal_grey' },
                    { name: 'Horno/Placa Cocina', brand: 'ApplianceCo', w: 0.6, h: 0.6, icon: 'üî•', type: 'appliance_square', 
                        styles: ['metal_grey'], defaultStyle: 'metal_grey' }
                ],
                'IKEA': [
                    { name: 'M√≥dulo Cocina Bajo 60cm', brand: 'IKEA', w: 0.6, h: 0.6, icon: 'üóÑÔ∏è', type: 'cabinet_low', 
                        styles: ['bed_white', 'wood_dark'], defaultStyle: 'bed_white' },
                    { name: 'Isla de Cocina UTBY', brand: 'IKEA', w: 1.2, h: 0.6, icon: 'üç≥', type: 'cabinet_low', 
                        styles: ['metal_grey', 'wood_dark'], defaultStyle: 'metal_grey' },
                    { name: 'Mesa Comedor NORDEN', brand: 'IKEA', w: 2.2, h: 0.8, icon: 'üçΩÔ∏è', type: 'table_rect', 
                        styles: ['wood_light'], defaultStyle: 'wood_light' }
                ],
                'Leroy Merl√≠n': [
                    { name: 'Carro Auxiliar Ruedas', brand: 'Leroy Merl√≠n', w: 0.4, h: 0.5, icon: 'üõí', type: 'cabinet_low', 
                        styles: ['wood_light', 'metal_grey'], defaultStyle: 'metal_grey' },
                    { name: 'Mesa Extensible 4p', brand: 'Leroy Merl√≠n', w: 1.2, h: 0.8, icon: 'üçΩÔ∏è', type: 'table_rect', 
                        styles: ['wood_dark'], defaultStyle: 'wood_dark' }
                ],
            },
            'office': {
                'IKEA': [
                    { name: 'Escritorio MICKE', brand: 'IKEA', w: 1.42, h: 0.50, icon: 'üñ•Ô∏è', type: 'table_rect', 
                        styles: ['bed_white', 'wood_dark'], defaultStyle: 'bed_white' },
                    { name: 'Silla MARKUS', brand: 'IKEA', w: 0.62, h: 0.65, icon: 'üí∫', type: 'sofa', 
                        styles: ['grey_fabric', 'leather_brown'], defaultStyle: 'grey_fabric' },
                    { name: 'Estanter√≠a KALLAX 2x2', brand: 'IKEA', w: 0.77, h: 0.39, icon: 'üìö', type: 'cabinet_low', 
                        styles: ['bed_white', 'wood_dark'], defaultStyle: 'bed_white' },
                    { name: 'Cajonera ALEX Ruedas', brand: 'IKEA', w: 0.36, h: 0.58, icon: 'üóÑÔ∏è', type: 'cabinet_low', 
                        styles: ['bed_white', 'metal_grey'], defaultStyle: 'bed_white' }
                ],
                'Leroy Merl√≠n': [
                    { name: 'Escritorio Esquinero', brand: 'Leroy Merl√≠n', w: 1.4, h: 1.4, icon: 'üìê', type: 'table_rect', 
                        styles: ['wood_light', 'metal_grey'], defaultStyle: 'wood_light' },
                    { name: 'Armario Archivador Alto', brand: 'Leroy Merl√≠n', w: 0.8, h: 0.4, icon: 'üóÉÔ∏è', type: 'cabinet_tall', 
                        styles: ['metal_grey', 'wood_light'], defaultStyle: 'metal_grey' },
                    { name: 'Sill√≥n de Visitas', brand: 'Leroy Merl√≠n', w: 0.6, h: 0.6, icon: 'ü™ë', type: 'sofa', 
                        styles: ['blue_velvet', 'grey_fabric'], defaultStyle: 'blue_velvet' }
                ],
                'Bauhaus': [
                    { name: 'Banco de Trabajo Fijo', brand: 'Bauhaus', w: 1.8, h: 0.7, icon: 'üî©', type: 'table_rect', 
                        styles: ['wood_dark', 'metal_grey'], defaultStyle: 'metal_grey' },
                    { name: 'Caja Fuerte Oficina', brand: 'Bauhaus', w: 0.5, h: 0.4, icon: 'üîí', type: 'cabinet_low', 
                        styles: ['metal_grey'], defaultStyle: 'metal_grey' },
                ]
            },
            'bathroom': {
                'IKEA': [
                    { name: 'Mueble Lavabo GODMORGON', brand: 'IKEA', w: 1.0, h: 0.47, icon: 'üõÅ', type: 'cabinet_low', 
                        styles: ['bed_white', 'wood_light'], defaultStyle: 'bed_white' },
                    { name: 'Espejo STORJORM LED', brand: 'IKEA', w: 0.8, h: 0.15, icon: 'ü™û', type: 'cabinet_low', 
                        styles: ['metal_grey'], defaultStyle: 'metal_grey' },
                    { name: 'Toallero ROTHEN', brand: 'IKEA', w: 0.45, h: 0.1, icon: 'üß∫', type: 'cabinet_low', 
                        styles: ['metal_grey'], defaultStyle: 'metal_grey' }
                ],
                'Leroy Merl√≠n': [
                    { name: 'Plato Ducha Rectangular', brand: 'Leroy Merl√≠n', w: 0.9, h: 0.9, icon: 'üöø', type: 'appliance_square', 
                        styles: ['bed_white'], defaultStyle: 'bed_white' },
                    { name: 'Ba√±era Acr√≠lica', brand: 'Leroy Merl√≠n', w: 1.7, h: 0.7, icon: 'üõÄ', type: 'appliance_square', 
                        styles: ['bed_white'], defaultStyle: 'bed_white' },
                    { name: 'Inodoro de Pie', brand: 'Leroy Merl√≠n', w: 0.4, h: 0.7, icon: 'üöΩ', type: 'appliance_square', 
                        styles: ['bed_white'], defaultStyle: 'bed_white' },
                    { name: 'Columna de Ducha', brand: 'Leroy Merl√≠n', w: 0.2, h: 0.2, icon: 'üíß', type: 'appliance_square', 
                        styles: ['metal_grey'], defaultStyle: 'metal_grey' }
                ],
                'Bauhaus': [
                    { name: 'Mueble Auxiliar Alto', brand: 'Bauhaus', w: 0.4, h: 0.3, icon: 'üóÑÔ∏è', type: 'cabinet_tall', 
                        styles: ['bed_white', 'wood_light'], defaultStyle: 'bed_white' },
                    { name: 'Lavabo sobre Encimera', brand: 'Bauhaus', w: 0.5, h: 0.5, icon: '‚ö™', type: 'table_round', 
                        styles: ['bed_white'], defaultStyle: 'bed_white' },
                ]
            },
            'garage': {
                'Leroy Merl√≠n': [
                    { name: 'Estanter√≠a Metal Alta', brand: 'Leroy Merl√≠n', w: 1.2, h: 0.5, icon: 'üõ†Ô∏è', type: 'cabinet_tall', 
                        styles: ['metal_grey'], defaultStyle: 'metal_grey' },
                    { name: 'Banco de Trabajo PRO', brand: 'Leroy Merl√≠n', w: 2.0, h: 0.8, icon: 'üî©', type: 'table_rect', 
                        styles: ['wood_dark', 'metal_grey'], defaultStyle: 'metal_grey' },
                    { name: 'Armario de Resina Exterior', brand: 'Leroy Merl√≠n', w: 0.7, h: 0.4, icon: 'üì¶', type: 'cabinet_tall', 
                        styles: ['grey_fabric'], defaultStyle: 'grey_fabric' },
                ],
                'Bauhaus': [
                    { name: 'Caja de Herramientas GIGANTE', brand: 'Bauhaus', w: 0.8, h: 0.4, icon: 'üß∞', type: 'cabinet_low', 
                        styles: ['metal_grey'], defaultStyle: 'metal_grey' },
                    { name: 'Estanter√≠a Modular ESQ', brand: 'Bauhaus', w: 1.0, h: 1.0, icon: 'üìê', type: 'cabinet_tall', 
                        styles: ['metal_grey'], defaultStyle: 'metal_grey' },
                    { name: 'Compresor Aire Fijo', brand: 'Bauhaus', w: 0.5, h: 0.5, icon: 'üí®', type: 'appliance_square', 
                        styles: ['metal_grey'], defaultStyle: 'metal_grey' }
                ],
                'IKEA': [
                    { name: 'Estanter√≠a HYLLIS', brand: 'IKEA', w: 0.6, h: 0.27, icon: 'ü™ú', type: 'cabinet_tall', 
                        styles: ['metal_grey'], defaultStyle: 'metal_grey' },
                ]
            }
        };
        const CATEGORY_NAMES = {
            'living': 'Sal√≥n',
            'bedroom': 'Dormitorio',
            'kitchen': 'Cocina/Comedor',
            'office': 'Oficina',
            'bathroom': 'Ba√±o',
            'garage': 'Garaje/Almac√©n'
        };


        // --- Variables de Configuraci√≥n y DOM ---
        const canvas = document.getElementById('roomPlanCanvas');
        const ctx = canvas.getContext('2d');
        const roomW = document.getElementById('roomW');
        const roomH = document.getElementById('roomH');
        const scaleInput = document.getElementById('scaleInput');
        const plankW = document.getElementById('plankW');
        const plankH = document.getElementById('plankH');
        const pattern = document.getElementById('pattern');
        const stagger = document.getElementById('stagger');
        const addCustomFurnitureButton = document.getElementById('addCustomFurnitureButton');
        const newFurnitureW = document.getElementById('newFurnitureW');
        const newFurnitureH = document.getElementById('newFurnitureH');
        const furnitureListEl = document.getElementById('furnitureList');
        const furnitureCatalogEl = document.getElementById('furnitureCatalog');
        const furnitureTabsEl = document.getElementById('furnitureTabs');
        const runAnalysisButton = document.getElementById('runAnalysisButton');
        const recalculateVisualButton = document.getElementById('recalculateVisualButton');
        const geminiOutputEl = document.getElementById('gemini-analysis-output');
        
        const selectionControlsEl = document.getElementById('selectionControls');
        const selectedDetailsEl = document.getElementById('selectedDetails');
        const rotateButton = document.getElementById('rotateButton');
        const deleteSelectedButton = document.getElementById('deleteSelectedButton');
        const styleOptionsContainer = document.getElementById('styleOptionsContainer');


        // Estado principal
        let furniture = []; 
        let nextFurnitureId = 1;
        let selectedFurniture = null; 
        let activeCategory = 'living'; 

        // Variables para arrastrar y soltar (D&D y Touch)
        let isDragging = false;
        let dragOffsetX = 0; 
        let dragOffsetY = 0; 

        // --- Estado del An√°lisis de Corte ---
        let adaptedCuts = []; 
        let isAnalysisActive = false; 

        // --- Core Helper Functions ---

        // Converts meters to pixels
        const mToPx = (m) => m * parseFloat(scaleInput.value); 
        // Converts pixels to meters
        const pxToM = (px) => px / parseFloat(scaleInput.value);

        function updateScaleAndCanvas() {
            const scale = parseFloat(scaleInput.value);
            const rW = parseFloat(roomW.value);
            const rH = parseFloat(roomH.value);

            // Set canvas drawing dimensions
            canvas.width = rW * scale;
            canvas.height = rH * scale;

            // Set CSS max height to prevent distortion on load
            canvas.style.maxHeight = `${canvas.height}px`;

            drawPlan();
            updateFurnitureList();
        }

        /**
         * Calcula los rect√°ngulos de corte visual alrededor de cada mueble.
         */
        function recalculateCuts() {
            const CUT_BUFFER = 0.05; // 5 cm de buffer alrededor del mueble
            const roomW_m = parseFloat(roomW.value);
            const roomH_m = parseFloat(roomH.value);

            adaptedCuts = furniture.map(f => {
                // Calcular posici√≥n y tama√±o con buffer
                const x_start = Math.max(0, f.x - CUT_BUFFER);
                const y_start = Math.max(0, f.y - CUT_BUFFER);
                const x_end = Math.min(roomW_m, f.x + f.w + CUT_BUFFER);
                const y_end = Math.min(roomH_m, f.y + f.h + CUT_BUFFER);

                return {
                    x: x_start,
                    y: y_start,
                    w: x_end - x_start,
                    h: y_end - y_start,
                };
            });
        }


        // --- Drawing Functions ---

        function drawPlank(xPos, yPos, w, h, color) {
            ctx.fillStyle = color;
            ctx.fillRect(xPos, yPos, w, h);
            ctx.strokeStyle = '#333333';
            ctx.lineWidth = 1;
            ctx.strokeRect(xPos, yPos, w, h);
        }

        /**
         * Dibuja el patr√≥n del suelo.
         */
        function drawFloor(roomW_px, roomH_px, plankW_px, plankH_px, currentPattern) {
            const baseColor = '#b58f6e';
            const lightColor = '#c4a78e';
            const staggerPercent = parseFloat(stagger.value) / 100;
            ctx.save();
            ctx.lineWidth = 1;

            if (currentPattern === 'straight') {
                let y = 0;
                let rowCount = 0;

                while (y < roomH_px) {
                    let xOffset = (plankH_px * staggerPercent * rowCount) % plankH_px;
                    let x = -xOffset;
                    let plankColor = rowCount % 2 === 0 ? baseColor : lightColor;
                    
                    while (x < roomW_px) {
                        const drawX = Math.max(0, x);
                        const drawW = Math.min(plankH_px, roomW_px - x);
                        const drawH = Math.min(plankW_px, roomH_px - y);
                        
                        if (drawW > 0 && drawH > 0) {
                            drawPlank(drawX, y, drawW, drawH, plankColor);
                        }
                        x += plankH_px; 
                    }
                    
                    y += plankW_px; 
                    rowCount++;
                }

            } else if (currentPattern === 'herringbone') {
                ctx.fillStyle = baseColor; 
                ctx.fillRect(0, 0, roomW_px, roomH_px);
                
                ctx.strokeStyle = lightColor;
                ctx.lineWidth = 2; 
                
                const unitSize = plankW_px * 2; 
                
                for (let i = -roomH_px; i < roomW_px + roomH_px; i += unitSize) {
                    ctx.beginPath();
                    ctx.moveTo(i, 0);
                    ctx.lineTo(i + roomH_px, roomH_px);
                    ctx.stroke();

                    ctx.beginPath();
                    ctx.moveTo(i, roomH_px);
                    ctx.lineTo(i + roomH_px, 0);
                    ctx.stroke();
                }
            }
            ctx.restore();
        }

        // --- Funciones de Dibujo Detallado por Tipo ---

        function drawSofa(f, w_px, h_px, style) {
            const backrestH = h_px * 0.15; // 15% para el respaldo
            const armW = w_px * 0.05;     // 5% para los reposabrazos

            // 1. Cuerpo (Base)
            ctx.fillStyle = style.fill;
            ctx.fillRect(-w_px / 2, -h_px / 2, w_px, h_px);

            // 2. Cojines
            const cushionH = h_px - backrestH;
            ctx.fillStyle = style.cushion;
            // Dibujar el √°rea del asiento sin el respaldo ni los reposabrazos
            ctx.fillRect(-w_px / 2 + armW, -h_px / 2 + backrestH, w_px - 2 * armW, cushionH - backrestH - armW);
            
            // 3. Respaldo (Detalle)
            ctx.fillStyle = style.detail;
            ctx.fillRect(-w_px / 2, -h_px / 2, w_px, backrestH); 
        }
        
        function drawOttoman(f, w_px, h_px, style) {
            // 1. Cuerpo (Base)
            ctx.fillStyle = style.fill;
            ctx.fillRect(-w_px / 2, -h_px / 2, w_px, h_px);

            // 2. Coj√≠n (Ligeramente m√°s claro y peque√±o, sin respaldo)
            const padding = w_px * 0.08;
            ctx.fillStyle = style.cushion;
            ctx.fillRect(-w_px / 2 + padding, -h_px / 2 + padding, w_px - 2 * padding, h_px - 2 * padding);
            
            // 3. Detalle (Costura central)
            ctx.strokeStyle = style.detail;
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(0, -h_px / 2 + padding);
            ctx.lineTo(0, h_px / 2 - padding);
            ctx.stroke();
        }


        function drawBedDouble(f, w_px, h_px, style) {
            const headboardH = h_px * 0.05;

            // 1. Base (Colch√≥n y s√°banas)
            ctx.fillStyle = style.bed;
            ctx.fillRect(-w_px / 2, -h_px / 2, w_px, h_px);

            // 2. Edred√≥n/Manta
            ctx.fillStyle = style.fill;
            ctx.fillRect(-w_px / 2, -h_px / 2, w_px, h_px * 0.7);

            // 3. Almohadas (Simplificadas)
            ctx.fillStyle = style.detail;
            const pillowW = w_px / 3;
            const pillowH = h_px * 0.1;
            ctx.fillRect(-w_px / 2 + w_px * 0.05, h_px / 2 - pillowH - h_px * 0.05, pillowW, pillowH);
            ctx.fillRect(w_px / 2 - pillowW - w_px * 0.05, h_px / 2 - pillowH - h_px * 0.05, pillowW, pillowH);

            // 4. Cabecera
            ctx.fillStyle = style.detail;
            ctx.fillRect(-w_px / 2, h_px / 2 - headboardH, w_px, headboardH); 
        }

        function drawTableRect(f, w_px, h_px, style) {
            const legSize = Math.min(w_px, h_px) * 0.08;

            // 1. Tablero
            ctx.fillStyle = style.fill;
            ctx.fillRect(-w_px / 2, -h_px / 2, w_px, h_px);

            // 2. Contorno del Tablero
            ctx.strokeStyle = style.detail;
            ctx.lineWidth = 2;
            ctx.strokeRect(-w_px / 2, -h_px / 2, w_px, h_px);
            
            // 3. Patas (Simplificadas como cuadrados s√≥lidos)
            ctx.fillStyle = style.detail;
            // Pata Superior Izquierda
            ctx.fillRect(-w_px / 2, -h_px / 2, legSize, legSize); 
            // Pata Superior Derecha
            ctx.fillRect(w_px / 2 - legSize, -h_px / 2, legSize, legSize);
            // Pata Inferior Izquierda
            ctx.fillRect(-w_px / 2, h_px / 2 - legSize, legSize, legSize);
            // Pata Inferior Derecha
            ctx.fillRect(w_px / 2 - legSize, h_px / 2 - legSize, legSize, legSize);
        }

        function drawTableRound(f, w_px, h_px, style) {
            const radius = w_px / 2;
            const legSize = w_px * 0.05; // Tama√±o de la pata central

            // 1. Tablero (C√≠rculo)
            ctx.fillStyle = style.fill;
            ctx.beginPath();
            ctx.arc(0, 0, radius, 0, 2 * Math.PI);
            ctx.fill();

            // 2. Contorno del Tablero
            ctx.strokeStyle = style.detail;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(0, 0, radius, 0, 2 * Math.PI);
            ctx.stroke();

            // 3. Pata central (Simplificada como un peque√±o cuadrado)
            ctx.fillStyle = style.detail;
            ctx.fillRect(-legSize / 2, -legSize / 2, legSize, legSize); 
        }


        // Cajoneras/Armarios (m√°s detallado)
        function drawCabinetLow(f, w_px, h_px, style) {
            // 1. Cuerpo
            ctx.fillStyle = style.fill;
            ctx.fillRect(-w_px / 2, -h_px / 2, w_px, h_px);

            // 2. Contorno
            ctx.strokeStyle = style.detail;
            ctx.lineWidth = 2;
            ctx.strokeRect(-w_px / 2, -h_px / 2, w_px, h_px);
            
            // 3. Divisiones/Cajones (L√≠neas divisorias simples)
            ctx.strokeStyle = style.detail;
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(-w_px / 2, 0);
            ctx.lineTo(w_px / 2, 0);
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(0, -h_px / 2);
            ctx.lineTo(0, h_px / 2);
            ctx.stroke();
        }

        // Default o Personalizado (simple relleno)
        function drawDefault(f, w_px, h_px, style) {
            ctx.fillStyle = style.fill;
            ctx.fillRect(-w_px / 2, -h_px / 2, w_px, h_px);

            ctx.strokeStyle = style.detail;
            ctx.lineWidth = 2;
            ctx.strokeRect(-w_px / 2, -h_px / 2, w_px, h_px);
        }

        // --- Funci√≥n de Dibujo Principal del Mueble ---

        function drawFurnitureVisual(f, s, isSelected) {
            const fx_px = f.x * s; 
            const fy_px = f.y * s; 
            const fw_px = f.w * s; 
            const fh_px = f.h * s; 
            
            const angle = f.rotation * Math.PI / 180;
            const style = STYLES[f.selectedStyleKey] || STYLES['custom_default'];
            
            // 1. Aplicar transformaciones de rotaci√≥n
            ctx.save();
            ctx.translate(fx_px + fw_px / 2, fy_px + fh_px / 2);
            ctx.rotate(angle);
            
            // 2. Dibujar el mueble seg√∫n su tipo con el estilo seleccionado
            switch (f.type) {
                case 'sofa':
                case 'armchair':
                    drawSofa(f, fw_px, fh_px, style);
                    break;
                case 'ottoman': 
                    drawOttoman(f, fw_px, fh_px, style);
                    break;
                case 'bed_double':
                case 'bed_single':
                    drawBedDouble(f, fw_px, fh_px, style);
                    break;
                case 'table_rect':
                    drawTableRect(f, fw_px, fh_px, style);
                    break;
                case 'table_round': 
                    // Nota: para la mesa redonda, w y h son el di√°metro
                    drawTableRound(f, fw_px, fh_px, style);
                    break;
                case 'cabinet_low':
                case 'cabinet_tall':
                case 'appliance_square':
                    drawCabinetLow(f, fw_px, fh_px, style);
                    break;
                default:
                    drawDefault(f, fw_px, fh_px, style);
            }

            // 3. Dibujar contorno de selecci√≥n (si est√° seleccionado)
            if (isSelected) {
                ctx.strokeStyle = '#ef4444'; // Rojo de selecci√≥n
                ctx.lineWidth = 3;
                
                // Para las mesas redondas, el recuadro es m√°s informativo que el c√≠rculo
                ctx.strokeRect(-fw_px / 2, -fh_px / 2, fw_px, fh_px);
            }

            // 4. Dibujar icono y nombre (en el centro)
            ctx.fillStyle = isSelected ? '#ef4444' : style.detail;
            ctx.font = `${Math.min(30, fw_px / 4, fh_px / 4)}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(f.icon || '‚¨õ', 0, -5); 

            ctx.font = `${Math.min(12, fw_px / 6)}px Arial`;
            ctx.fillStyle = isSelected ? '#ef4444' : style.detail;
            ctx.fillText(f.name.split(' ')[0], 0, 15);

            // 5. Restaurar transformaciones
            ctx.restore();
        }


        function drawCuts() {
            if (!isAnalysisActive || adaptedCuts.length === 0) return;
            
            ctx.save();
            ctx.strokeStyle = '#ef4444'; 
            ctx.lineWidth = 4;
            ctx.setLineDash([8, 8]); 
            ctx.globalAlpha = 0.8;

            adaptedCuts.forEach(cut => {
                const x_px = mToPx(cut.x);
                const y_px = mToPx(cut.y);
                const w_px = mToPx(cut.w);
                const h_px = mToPx(cut.h);
                ctx.strokeRect(x_px, y_px, w_px, h_px);
            });
            ctx.restore();
        }


        function drawPlan() {
            const rW_m = parseFloat(roomW.value);
            const rH_m = parseFloat(roomH.value);
            const scale = parseFloat(scaleInput.value);
            const plankW_m = parseFloat(plankW.value);
            const plankH_m = parseFloat(plankH.value);
            const currentPattern = pattern.value;

            const rW_px = mToPx(rW_m);
            const rH_px = mToPx(rH_m);
            const plankW_px = mToPx(plankW_m);
            const plankH_px = mToPx(plankH_m);

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 1. Dibujar el suelo (patr√≥n), COMPLETO
            drawFloor(rW_px, rH_px, plankW_px, plankH_px, currentPattern);

            // 2. Dibujar zonas de corte adaptadas
            drawCuts();

            // 3. Dibujar los muebles (que ahora son opacos y cubren el suelo)
            furniture.forEach(f => {
                drawFurnitureVisual(f, scale, selectedFurniture && selectedFurniture.id === f.id);
            });

            // 4. Dibujar borde de la sala
            ctx.strokeStyle = '#1f2937';
            ctx.lineWidth = 4;
            ctx.strokeRect(0, 0, rW_px, rH_px);
        }
        
        // --- Furniture List and Selection ---

        function updateFurnitureList() {
            furnitureListEl.innerHTML = '';
            
            furniture.forEach(f => {
                const item = document.createElement('div');
                item.className = `furniture-item ${selectedFurniture && selectedFurniture.id === f.id ? 'selected' : ''}`;
                item.dataset.id = f.id;

                // Nota: La marca siempre est√° en el objeto 'f'
                
                item.innerHTML = `
                    <div class="furniture-details">
                        <p><strong>${f.name.split(' ')[0]}</strong> (${f.icon || '‚¨õ'})</p>
                        <p style="font-size:12px; color:var(--muted);">
                            Marca: <span style="color:#10b981;">${f.brand}</span> | ${f.w.toFixed(2)}x${f.h.toFixed(2)}m
                        </p>
                    </div>
                    <button data-id="${f.id}" style="background-color: #ef4444; padding: 5px 10px; font-size: 12px;">X</button>
                `;
                furnitureListEl.appendChild(item);
            });
        }
        
        // --- Style Selector Handler ---
        function renderStyleSelector() {
            styleOptionsContainer.innerHTML = '';
            
            if (!selectedFurniture) return;

            // Para encontrar las definiciones base, iteramos sobre todas las marcas
            let baseTypeDefinition = { styles: ['custom_default'] };
            
            for (const room in PREDEFINED_FURNITURE) {
                for (const brand in PREDEFINED_FURNITURE[room]) {
                    const found = PREDEFINED_FURNITURE[room][brand].find(f => 
                        f.type === selectedFurniture.type && f.name === selectedFurniture.name
                    );
                    if (found) {
                        baseTypeDefinition = found;
                        break;
                    }
                }
            }
            
            // Si es un mueble personalizado, usamos el default gen√©rico
            const availableStyles = selectedFurniture.type === 'custom' 
                ? ['custom_default', 'wood_light', 'metal_grey'] 
                : (baseTypeDefinition.styles || ['custom_default']);

            availableStyles.forEach(styleKey => {
                const styleDef = STYLES[styleKey];
                if (!styleDef) return;

                const option = document.createElement('div');
                option.className = `style-option ${selectedFurniture.selectedStyleKey === styleKey ? 'selected' : ''}`;
                option.dataset.key = styleKey;
                option.dataset.name = styleDef.name;
                option.style.backgroundColor = styleDef.fill;
                option.title = styleDef.name;
                
                // Un patr√≥n visual simple para las maderas
                if (styleDef.pattern === 'line') {
                    option.style.backgroundImage = `repeating-linear-gradient(45deg, ${styleDef.detail} 0, ${styleDef.detail} 1px, ${styleDef.fill} 1px, ${styleDef.fill} 10px)`;
                }

                option.addEventListener('click', (e) => {
                    e.stopPropagation(); // Evita que se deseleccione al cambiar el estilo
                    selectedFurniture.selectedStyleKey = styleKey;
                    renderStyleSelector(); // Vuelve a renderizar para actualizar la selecci√≥n
                    drawPlan();
                    updateFurnitureList();
                });
                styleOptionsContainer.appendChild(option);
            });
        }

        function selectFurniture(id) {
            selectedFurniture = furniture.find(f => f.id === id);
            if (selectedFurniture) {
                selectionControlsEl.style.display = 'block';
                // La marca se muestra en el panel de detalles
                selectedDetailsEl.innerHTML = `
                    <strong>${selectedFurniture.name}</strong> (${selectedFurniture.icon || '‚¨õ'})<br>
                    Marca: <span style="color:#10b981; font-weight:700;">${selectedFurniture.brand}</span><br>
                    Tama√±o: ${selectedFurniture.w.toFixed(2)}m x ${selectedFurniture.h.toFixed(2)}m<br>
                    Posici√≥n: X:${selectedFurniture.x.toFixed(2)}m, Y:${selectedFurniture.y.toFixed(2)}m
                `;
                renderStyleSelector();
            } else {
                selectionControlsEl.style.display = 'none';
                styleOptionsContainer.innerHTML = '';
            }
            drawPlan();
            updateFurnitureList();
        }

        // --- Dragging Logic (Unified for mouse and touch) ---

        function getEventPos(e) {
            const rect = canvas.getBoundingClientRect();
            let clientX, clientY;
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            const scaleFactor = canvas.width / rect.width;

            return {
                x: (clientX - rect.left) * scaleFactor,
                y: (clientY - rect.top) * scaleFactor
            };
        }

        function onPointerDown(e) {
            e.preventDefault();
            const pos = getEventPos(e);
            
            const hitItem = furniture.find(item => {
                const x_px = mToPx(item.x);
                const y_px = mToPx(item.y);
                const w_px = mToPx(item.w);
                const h_px = mToPx(item.h);
                
                // Simple AABB hit check (ignoring rotation for simplicity in 2D top-down selection)
                return pos.x >= x_px && pos.x <= x_px + w_px &&
                       pos.y >= y_px && pos.y <= y_px + h_px;
            });

            if (hitItem) {
                selectFurniture(hitItem.id);
                isDragging = true;
                dragOffsetX = pos.x - mToPx(hitItem.x);
                dragOffsetY = pos.y - mToPx(hitItem.y);
                canvas.style.cursor = 'grabbing';
            } else {
                selectFurniture(null); // Deseleccionar si se hace clic fuera
            }
        }

        function onPointerMove(e) {
            if (!isDragging || !selectedFurniture) return;
            e.preventDefault();
            
            const pos = getEventPos(e);
            const item = selectedFurniture;

            let newX_m = pxToM(pos.x - dragOffsetX);
            let newY_m = pxToM(pos.y - dragOffsetY);
            
            // Boundary check
            newX_m = Math.max(0, Math.min(newX_m, parseFloat(roomW.value) - item.w));
            newY_m = Math.max(0, Math.min(newY_m, parseFloat(roomH.value) - item.h));

            item.x = newX_m;
            item.y = newY_m;
            
            if (isAnalysisActive) {
                recalculateCuts(); 
            }

            drawPlan();
            updateFurnitureList();
            if (selectedFurniture) {
                // Actualiza solo la posici√≥n en el panel de detalles
                selectedDetailsEl.innerHTML = `
                    <strong>${selectedFurniture.name}</strong> (${selectedFurniture.icon || '‚¨õ'})<br>
                    Marca: <span style="color:#10b981; font-weight:700;">${selectedFurniture.brand}</span><br>
                    Tama√±o: ${selectedFurniture.w.toFixed(2)}m x ${selectedFurniture.h.toFixed(2)}m<br>
                    Posici√≥n: X:${selectedFurniture.x.toFixed(2)}m, Y:${selectedFurniture.y.toFixed(2)}m
                `;
            }
        }

        function onPointerUp() {
            isDragging = false;
            canvas.style.cursor = selectedFurniture ? 'pointer' : 'default';
        }

        // --- Event Listeners ---

        document.querySelectorAll('#roomW, #roomH, #scaleInput, #plankW, #plankH, #pattern, #stagger').forEach(input => {
            input.addEventListener('change', updateScaleAndCanvas);
        });

        canvas.addEventListener('mousedown', onPointerDown);
        canvas.addEventListener('mousemove', onPointerMove);
        canvas.addEventListener('mouseup', onPointerUp);
        canvas.addEventListener('mouseleave', onPointerUp); 

        canvas.addEventListener('touchstart', onPointerDown);
        canvas.addEventListener('touchmove', onPointerMove);
        canvas.addEventListener('touchend', onPointerUp);
        canvas.addEventListener('touchcancel', onPointerUp);

        // --- Furniture Interaction Listeners ---

        function handleFurnitureChange() {
            if (isAnalysisActive) {
                recalculateCuts();
                geminiOutputEl.innerHTML = '<p class="text-gray-600 italic">‚ö†Ô∏è Plano modificado. Presione el bot√≥n 1 para un nuevo an√°lisis completo (IA), si es necesario.</p>';
            }
            updateScaleAndCanvas(); 
        }

        addCustomFurnitureButton.addEventListener('click', () => {
            const w = parseFloat(newFurnitureW.value);
            const h = parseFloat(newFurnitureH.value);
            if (w > 0 && h > 0) {
                const newF = { 
                    id: nextFurnitureId++, 
                    x: 0.5, y: 0.5, w, h, 
                    icon: '‚ùì', type: 'custom', rotation: 0, 
                    name: 'Personalizado',
                    brand: 'Dise√±o Propio', // Marca para muebles personalizados
                    selectedStyleKey: 'custom_default' 
                };
                furniture.push(newF);
                handleFurnitureChange(); 
                selectFurniture(newF.id);
            }
        });

        // Delete button listener
        deleteSelectedButton.addEventListener('click', () => {
            if (selectedFurniture) {
                furniture = furniture.filter(f => f.id !== selectedFurniture.id);
                selectFurniture(null);
                handleFurnitureChange();
            }
        });

        // Rotate button listener (rotates by 90 degrees)
        rotateButton.addEventListener('click', () => {
            if (selectedFurniture) {
                // Rotar 90 grados
                selectedFurniture.rotation = (selectedFurniture.rotation + 90) % 360;
                
                // Intercambiar Ancho y Alto
                [selectedFurniture.w, selectedFurniture.h] = [selectedFurniture.h, selectedFurniture.w];
                
                handleFurnitureChange();
                drawPlan();
                updateFurnitureList(); 
            }
        });

        furnitureListEl.addEventListener('click', (e) => {
            const deleteButton = e.target.closest('button');
            if (deleteButton) {
                const id = parseInt(deleteButton.dataset.id);
                furniture = furniture.filter(f => f.id !== id);
                selectFurniture(null);
                handleFurnitureChange();
                return;
            }
            const item = e.target.closest('.furniture-item');
            if (item) {
                const id = parseInt(item.dataset.id);
                selectFurniture(id);
            }
        });


        // --- Manual Recalculation Button Handler (Refresca) ---
        recalculateVisualButton.addEventListener('click', () => {
            if (!isAnalysisActive) {
                geminiOutputEl.innerHTML = '<p style="color:#ef4444; font-weight:bold;">Error: Ejecuta primero la Simulaci√≥n de Corte (Bot√≥n 1) para activar el an√°lisis.</p>';
                return;
            }

            recalculateCuts();
            drawPlan();
            
            geminiOutputEl.innerHTML = '<p class="text-gray-600 italic">La visualizaci√≥n de las zonas de corte (l√≠neas rojas) ha sido forzada a refrescar.</p>';
        });


        // --- Gemini API Integration (Bot√≥n 1) ---

        runAnalysisButton.addEventListener('click', analyzeCuttingSimulation);

        async function analyzeCuttingSimulation() {
            if (!isAuthReady) {
                geminiOutputEl.innerHTML = '<p style="color:#ef4444; font-weight:bold;">Error: Autenticaci√≥n no lista. Int√©ntalo de nuevo.</p>';
                return;
            }
            
            if (furniture.length === 0) {
                geminiOutputEl.innerHTML = '<p style="color:#f59e0b; font-weight:bold;">Aviso: A√±ade muebles al plano para realizar un an√°lisis de corte.</p>';
                isAnalysisActive = false; 
                adaptedCuts = []; 
                drawPlan();
                return;
            }

            // 1. Activar el an√°lisis visual y calcular la posici√≥n de los cortes
            isAnalysisActive = true; 
            recalculateCuts(); 
            drawPlan(); 

            // Show loading state
            runAnalysisButton.disabled = true;
            geminiOutputEl.innerHTML = `
                <div class="gemini-loading">
                    <svg class="animate-spin h-5 w-5 text-current" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Analizando corte...
                </div>
            `;
            
            const roomW_m = parseFloat(roomW.value).toFixed(2);
            const roomH_m = parseFloat(roomH.value).toFixed(2);
            const plankL = parseFloat(plankH.value).toFixed(2); 
            const plankW = parseFloat(plankW.value).toFixed(2); 
            const currentPattern = pattern.value === 'straight' ? `Recto con desfase del ${stagger.value}%` : 'Espiga (Herringbone) a 45 grados';
            
            const furnitureDetails = furniture.map(f => {
                const x = f.x.toFixed(2);
                const y = f.y.toFixed(2);
                const w = f.w.toFixed(2);
                const h = f.h.toFixed(2);
                const r = f.rotation;
                return `- ${f.name} (${f.brand}, ${w}m x ${h}m, Rotaci√≥n: ${r}¬∞) ubicado en (X:${x}m, Y:${y}m).`;
            }).join('\n');

            const userQuery = `Realiza un an√°lisis profesional de la simulaci√≥n de corte para el suelo laminado:
            
Habitaci√≥n: Ancho ${roomW_m} metros (eje X) x Alto ${roomH_m} metros (eje Y).
Dimensiones de lama: Largo ${plankL}m, Ancho ${plankW}m.
Patr√≥n de instalaci√≥n: ${currentPattern}.

Mobiliario y Obst√°culos:
${furnitureDetails}

Proporciona una gu√≠a concisa y pr√°ctica:
1. Recomendaci√≥n del punto de inicio y direcci√≥n de las lamas (para reducir el desperdicio y que los cortes junto al mobiliario sean est√©ticos).
2. Estimaci√≥n del desperdicio de material (en porcentaje, con una justificaci√≥n breve basada en el patr√≥n y los obst√°culos).
3. Detalles sobre el tipo de cortes especiales requeridos (ej. alrededor de los muebles) y c√≥mo minimizarlos.`;

            const systemPrompt = `Act√∫a como un maestro instalador de suelos con m√°s de 20 a√±os de experiencia. Tu respuesta debe ser una lista de puntos clara y profesional, enfocada en la eficiencia y la calidad est√©tica del acabado. Responde en espa√±ol.`;

            const apiKey = "" 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=`;
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }], 
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const MAX_RETRIES = 3;
            for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "No se pudo obtener el an√°lisis. Int√©ntalo de nuevo.";
                    
                    const formattedText = text.replace(/\n/g, '<br>');
                    geminiOutputEl.innerHTML = `<p>${formattedText}</p>`;
                    
                    break; 

                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error);
                    if (attempt === MAX_RETRIES - 1) {
                        geminiOutputEl.innerHTML = `<p style="color:#ef4444;">Error de red. No se pudo obtener el an√°lisis tras ${MAX_RETRIES} intentos.</p>`;
                    } else {
                        const delay = Math.pow(2, attempt) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }
            
            runAnalysisButton.disabled = false;
        }

        // --- Catalog & Initialization Functions (ACTUALIZADA) ---

        function renderFurnitureCatalog(category) {
            furnitureCatalogEl.innerHTML = '';
            const brands = PREDEFINED_FURNITURE[category];
            
            for (const brandName in brands) {
                if (brands.hasOwnProperty(brandName)) {
                    // 1. Crear el encabezado de la Marca (simulando una carpeta)
                    const brandHeader = document.createElement('h4');
                    brandHeader.className = 'brand-header';
                    brandHeader.innerHTML = `üì¶ ${brandName}`;
                    furnitureCatalogEl.appendChild(brandHeader);
                    
                    // 2. Crear un contenedor flexible para los muebles de esa marca
                    const itemsContainer = document.createElement('div');
                    itemsContainer.className = 'furniture-brand-container';

                    brands[brandName].forEach((f) => {
                        const card = document.createElement('div');
                        card.className = 'furniture-card';
                        // Solo muestra el primer nombre para no exceder el espacio
                        card.innerHTML = `
                            <span class="furniture-icon">${f.icon}</span>
                            <strong>${f.name.split(' ')[0]}...</strong>
                            <p>${f.w}x${f.h}m</p>
                        `;
                        card.title = f.name + ' (' + f.brand + ')'; 
                        card.addEventListener('click', () => {
                            const newF = {
                                id: nextFurnitureId++,
                                x: 0.5, 
                                y: 0.5, 
                                w: f.w, 
                                h: f.h, 
                                icon: f.icon, 
                                type: f.type, 
                                rotation: 0, 
                                name: f.name,
                                brand: f.brand, // La marca se copia directamente
                                selectedStyleKey: f.defaultStyle
                            };
                            furniture.push(newF);
                            
                            handleFurnitureChange(); 
                            selectFurniture(newF.id);
                        });
                        itemsContainer.appendChild(card);
                    });
                    
                    furnitureCatalogEl.appendChild(itemsContainer);
                }
            }
        }

        furnitureTabsEl.addEventListener('click', (e) => {
            if (e.target.classList.contains('tab-button')) {
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                activeCategory = e.target.dataset.category;
                renderFurnitureCatalog(activeCategory);
            }
        });

        // Toggle functionality for control groups
        document.querySelectorAll('.collapsible-header').forEach(header => {
            header.addEventListener('click', () => {
                const group = header.closest('.control-group');
                group.classList.toggle('open');
            });
        });


        // --- Initial Load ---
        window.onload = function() {
            // Populate furniture catalog tabs and content (simplified)
            Object.keys(CATEGORY_NAMES).forEach(key => {
                const button = document.createElement('button');
                button.className = `tab-button ${key === activeCategory ? 'active' : ''}`;
                button.textContent = CATEGORY_NAMES[key];
                button.dataset.category = key;
                furnitureTabsEl.appendChild(button);
            });
            renderFurnitureCatalog(activeCategory);
            
            // Initial render
            updateScaleAndCanvas(); 
            canvas.style.cursor = 'default';
            window.addEventListener('resize', updateScaleAndCanvas);
        };

    </script>
</body>
</html>